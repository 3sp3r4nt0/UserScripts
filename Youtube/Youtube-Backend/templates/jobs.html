<!-- templates/jobs.html -->
{% extends "base.html" %}

{% block title %}Jobs - YouTube Downloader{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ðŸ“‹ Download Jobs</h1>
    <p>View and manage your download jobs</p>
</div>

<section class="card">
    <div class="jobs-stats">
        <div class="stat-item">
            <span class="stat-value" id="total-jobs">{{ jobs|length }}</span>
            <span class="stat-label">Total Jobs</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="running-jobs">
                {{ jobs|selectattr('status', 'equalto', 'running')|list|length }}
            </span>
            <span class="stat-label">Running</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="completed-jobs">
                {{ jobs|selectattr('status', 'equalto', 'completed')|list|length }}
            </span>
            <span class="stat-label">Completed</span>
        </div>
    </div>
</section>

<section class="card">
    <h2>All Jobs</h2>
    <div id="jobs-list">
        {% if jobs %}
            {% for job in jobs|reverse %}
            <div class="job-item status-{{ job.status }}" id="job-{{ job.id }}">
                <div class="job-header">
                    <div class="job-info">
                        <h3>{{ job.name }}</h3>
                        <span class="job-meta">
                            {{ job.format_type|upper }} |
                            {{ job.total }} items |
                            Created: {{ job.created_at[:16] if job.created_at else 'Unknown' }}
                        </span>
                    </div>
                    <div class="job-status">
                        <span class="status-badge badge-{{ job.status }}">{{ job.status }}</span>
                    </div>
                </div>
                
                <div class="job-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ (job.completed_count / job.total * 100) if job.total > 0 else 0 }}%"></div>
                    </div>
                    <span class="progress-text">
                        {{ job.completed_count }}/{{ job.total }} completed
                        {% if job.error_count > 0 %}
                            | {{ job.error_count }} errors
                        {% endif %}
                        {% if job.skipped_count > 0 %}
                            | {{ job.skipped_count }} skipped
                        {% endif %}
                    </span>
                </div>
                
                <div class="job-actions">
                    <button class="btn btn-small" onclick="toggleJobDetails('{{ job.id }}')">Details</button>
                    {% if job.status == 'running' %}
                    <button class="btn btn-small btn-danger" onclick="cancelJob('{{ job.id }}')">Cancel</button>
                    {% endif %}
                </div>
                
                <div class="job-details" id="details-{{ job.id }}" style="display: none;">
                    <h4>Downloads:</h4>
                    {% for download in job.downloads %}
                    <div class="download-item mini status-{{ download.status }}">
                        <span class="download-title">{{ download.title }}</span>
                        <span class="download-status">{{ download.status }}</span>
                        {% if download.error %}
                        <span class="download-error">{{ download.error }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="no-jobs">No download jobs yet. Start downloading from the <a href="{{ url_for('index') }}">home page</a>!</p>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    const socket = io();

    // Function to toggle the visibility of job details
    function toggleJobDetails(jobId) {
        const details = document.getElementById(`details-${jobId}`);
        details.style.display = details.style.display === 'none' ? 'block' : 'none';
    }

    // Function to cancel a job
    async function cancelJob(jobId) {
        if (!confirm('Are you sure you want to cancel this job?')) return;

        try {
            const response = await fetch(`/jobs/${jobId}/cancel`, { method: 'POST' });
            const data = await response.json();

            if (data.status === 'cancelled') {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    // Socket event listeners to update UI in real-time
    socket.on('job_completed', function(job) {
        location.reload();
    });

    socket.on('download_progress', function(data) {
        // Update UI in real-time (e.g., show download progress)
        console.log('Progress:', data);
        // You can implement updating progress bars or other UI elements here
    });
</script>
{% endblock %}
