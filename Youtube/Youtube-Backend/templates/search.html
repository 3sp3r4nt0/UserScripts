<!-- templates/search.html -->
{% extends "base.html" %}

{% block title %}Search - YouTube Downloader{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üîç Search Videos</h1>
    <p>Search across multiple platforms and create download jobs</p>
</div>

<section class="card">
    <form id="search-form" class="search-form">
        <div class="form-row">
            <div class="form-group flex-grow">
                <input type="text" id="search-query" name="query" placeholder="Search for videos..." required>
            </div>
            <div class="form-group">
                <select id="search-site" name="site">
                    <option value="youtube">YouTube</option>
                    {% for site in supported_sites %}
                        {% if site != "YouTube" %}
                        <option value="{{ site|lower }}">{{ site }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <select id="max-results" name="max_results">
                    <option value="10">10 results</option>
                    <option value="20" selected>20 results</option>
                    <option value="50">50 results</option>
                </select>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </div>
    </form>
</section>

<!-- Selected Videos for Download -->
<section class="card" id="selected-section" style="display: none;">
    <div class="section-header">
        <h2>‚úÖ Selected Videos (<span id="selected-count">0</span>)</h2>
        <div class="section-actions">
            <select id="download-format">
                <option value="mp4">MP4</option>
                <option value="mp3">MP3</option>
            </select>
            <button id="download-selected" class="btn btn-success">Download Selected</button>
            <button id="clear-selected" class="btn btn-secondary">Clear</button>
        </div>
    </div>
    <div id="selected-list" class="selected-list"></div>
</section>

<!-- Search Results -->
<section class="card">
    <h2>üìã Search Results</h2>
    <div id="search-results">
        <p class="no-results">Enter a search query to find videos</p>
    </div>
</section>

{% endblock %}

{% block scripts %}
<script>
    const selectedVideos = new Map();
    
    document.getElementById('search-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const query = document.getElementById('search-query').value;
        const site = document.getElementById('search-site').value;
        const maxResults = document.getElementById('max-results').value;
        
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '<p class="loading">Searching...</p>';
        
        try {
            const response = await fetch('/search/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query, site, max_results: maxResults })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                displayResults(data.results);
            } else {
                resultsContainer.innerHTML = `<p class="error">Error: ${data.message}</p>`;
            }
        } catch (error) {
            resultsContainer.innerHTML = `<p class="error">Error: ${error.message}</p>`;
        }
    });
    
    function displayResults(results) {
        const container = document.getElementById('search-results');
        
        if (results.length === 0) {
            container.innerHTML = '<p class="no-results">No results found</p>';
            return;
        }
        
        container.innerHTML = results.map(video => `
            <div class="search-result" data-url="${video.url}" data-title="${escapeHtml(video.title)}">
                <div class="result-checkbox">
                    <input type="checkbox" id="video-${video.id}" 
                           ${selectedVideos.has(video.url) ? 'checked' : ''}
                           onchange="toggleSelection('${video.url}', '${escapeHtml(video.title)}', '${video.thumbnail}', this.checked)">
                </div>
                <img class="result-thumbnail" src="${video.thumbnail || '/static/img/no-thumb.png'}" alt="Thumbnail">
                <div class="result-info">
                    <h3 class="result-title">${escapeHtml(video.title)}</h3>
                    <p class="result-meta">
                        <span class="result-channel">${escapeHtml(video.channel || 'Unknown')}</span>
                        <span class="result-duration">${formatDuration(video.duration)}</span>
                        <span class="result-views">${(video.view_count || 0).toLocaleString()} views</span>
                    </p>
                </div>
                <div class="result-actions">
                    <button class="btn btn-small btn-primary" onclick="quickDownload('${video.url}', 'mp4')">MP4</button>
                    <button class="btn btn-small btn-secondary" onclick="quickDownload('${video.url}', 'mp3')">MP3</button>
                </div>
            </div>
        `).join('');
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }
    
    function formatDuration(seconds) {
        if (!seconds) return 'Unknown';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        return `${m}:${s.toString().padStart(2, '0')}`;
    }
    
    function toggleSelection(url, title, thumbnail, isSelected) {
        if (isSelected) {
            selectedVideos.set(url, { title, thumbnail });
        } else {
            selectedVideos.delete(url);
        }
        updateSelectedSection();
    }
    
    function updateSelectedSection() {
        const section = document.getElementById('selected-section');
        const list = document.getElementById('selected-list');
        const count = document.getElementById('selected-count');
        
        count.textContent = selectedVideos.size;
        
        if (selectedVideos.size > 0) {
            section.style.display = 'block';
            list.innerHTML = Array.from(selectedVideos.entries()).map(([url, info]) => `
                <div class="selected-item">
                    <img src="${info.thumbnail || ''}" alt="Thumb">
                    <span>${info.title}</span>
                    <button class="btn-remove" onclick="removeSelected('${url}')">√ó</button>
                </div>
            `).join('');
        } else {
            section.style.display = 'none';
        }
    }
    
    function removeSelected(url) {
        selectedVideos.delete(url);
        const checkbox = document.querySelector(`.search-result[data-url="${url}"] input[type="checkbox"]`);
        if (checkbox) checkbox.checked = false;
        updateSelectedSection();
    }
    
    document.getElementById('clear-selected').addEventListener('click', function() {
        selectedVideos.clear();
        document.querySelectorAll('.search-result input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateSelectedSection();
    });
    
    document.getElementById('download-selected').addEventListener('click', async function() {
        if (selectedVideos.size === 0) {
            alert('No videos selected');
            return;
        }
        
        const format = document.getElementById('download-format').value;
        const urls = Array.from(selectedVideos.keys());
        
        try {
            const response = await fetch('/download/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    urls: urls,
                    format: format,
                    name: `Search Download - ${new Date().toLocaleString()}`
                })
            });
            
            const data = await response.json();
            if (data.status === 'started') {
                alert(`Download started! Job ID: ${data.job_id}`);
                selectedVideos.clear();
                updateSelectedSection();
                window.location.href = '/jobs';
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
    
    async function quickDownload(url, format) {
        try {
            const formData = new FormData();
            formData.append('url', url);
            formData.append('format', format);
            
            const response = await fetch('/download', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            if (data.status === 'started') {
                alert('Download started!');
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
</script>
{% endblock %}